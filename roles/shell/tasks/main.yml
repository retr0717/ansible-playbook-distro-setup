---
- name: Setup Oh My Zsh for user
  block:
    - name: Install Oh My Zsh
      shell: |
        sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
      become_user: "{{ username }}"
      args:
        creates: "/home/{{ username }}/.oh-my-zsh"

    - name: Configure zsh theme
      lineinfile:
        path: "/home/{{ username }}/.zshrc"
        regexp: '^ZSH_THEME='
        line: 'ZSH_THEME="{{ zsh_theme }}"'
      become_user: "{{ username }}"

    - name: Configure zsh plugins
      lineinfile:
        path: "/home/{{ username }}/.zshrc"
        regexp: '^plugins='
        line: 'plugins=({{ zsh_plugins | join(" ") }})'
      become_user: "{{ username }}"

    - name: Clone zsh-autosuggestions plugin
      git:
        repo: https://github.com/zsh-users/zsh-autosuggestions
        dest: "/home/{{ username }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
        force: yes
      become_user: "{{ username }}"

    - name: Clone zsh-syntax-highlighting plugin
      git:
        repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
        dest: "/home/{{ username }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
        force: yes
      become_user: "{{ username }}"

    - name: Add environment variables to .zshrc
      lineinfile:
        path: "/home/{{ username }}/.zshrc"
        line: "{{ item }}"
        insertafter: EOF
      loop:
        - ''
        - '# Pyenv configuration'
        - 'export PYENV_ROOT="$HOME/.pyenv"'
        - 'export PATH="$PYENV_ROOT/bin:$PATH"'
        - 'if command -v pyenv >/dev/null 2>&1; then'
        - '    eval "$(pyenv init -)"'
        - 'fi'
        - ''
        - '# Rust configuration'
        - 'export PATH="$HOME/.cargo/bin:$PATH"'
      become_user: "{{ username }}"

- name: Change user shell to zsh
  user:
    name: "{{ username }}"
    shell: /bin/zsh
